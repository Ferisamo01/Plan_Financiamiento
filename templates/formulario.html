<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Financiamiento - Zest</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/form.css') }}">
</head>
<body>
    <header class="form-header">
        <img src="{{ url_for('static', filename='img/zest_logo.png') }}" alt="Zest Logo" class="logo">
        <h1>Plan de Financiamiento Zest</h1>
    </header>

    <main class="form-container">
        <div id="progress-bar">
            <div id="progress"></div>
        </div>

        <form id="financingForm">
            <!-- ==================== PASO 1 ==================== -->
            <div class="form-step active" id="step-1">
                <h2>Datos Personales del Solicitante</h2>

                <label for="tipo_id">Tipo de documento:</label>
                <select name="tipo_id" id="tipo_id" required>
                    <option value="">Seleccione...</option>
                    <option value="DNI">DNI</option>
                    <option value="CE">Carnet de Extranjería</option>
                    <option value="PAS">Pasaporte</option>
                </select>

                <label for="numero_id">Número de identificación:</label>
                <input type="text" id="numero_id" name="numero_id" required>

                <label for="nombres">Nombres:</label>
                <input type="text" id="nombres" name="nombres" required>

                <label for="apellidos">Apellidos:</label>
                <input type="text" id="apellidos" name="apellidos" required>

                <label for="correo">Correo electrónico:</label>
                <input type="email" id="correo" name="correo" required>

                <label for="fecha_nacimiento">Fecha de nacimiento:</label>
                <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" required>

                <label for="estado_civil">Estado civil:</label>
                <select id="estado_civil" name="estado_civil" required>
                    <option value="">Seleccione...</option>
                    <option value="Soltero">Soltero(a)</option>
                    <option value="Casado">Casado(a)</option>
                    <option value="Divorciado">Divorciado(a)</option>
                    <option value="Viudo">Viudo(a)</option>
                </select>

                <div id="conyuge_section" class="hidden">
                    <h3>Datos del Cónyuge</h3>
                    <label for="nombre_conyuge">Nombre completo:</label>
                    <input type="text" id="nombre_conyuge" name="nombre_conyuge">

                    <label for="fecha_conyuge">Fecha de nacimiento:</label>
                    <input type="date" id="fecha_conyuge" name="fecha_conyuge">
                </div>

                <label for="tiene_hijos">¿Tiene hijos?</label>
                <select id="tiene_hijos" name="tiene_hijos" required>
                    <option value="">Seleccione...</option>
                    <option value="si">Sí</option>
                    <option value="no">No</option>
                </select>


                <div id="hijos_section" class="hidden">
                    <div id="lista_hijos"></div>
                    <button type="button" class="add-btn" id="agregar_hijo">Agregar hijo</button>
                </div>

                <label for="codigo">Iniciales o código referencial:</label>
                <input type="text" id="codigo" name="codigo">

                <label for="hub">Hub del asesor financiero:</label>
                <input type="text" id="hub" name="hub">

                <label for="objetivos">Objetivos y aspiraciones:</label>
                <textarea id="objetivos" name="objetivos" rows="3"></textarea>

                <div class="buttons">
                    <button type="button" id="btn-siguiente-1">Siguiente</button>
                </div>
            </div>

            <!-- PASO DE PERFILAMIENTO [OPCIONAL]-->
            <div class="form-step" id="step-perfilamiento">
                <h2>Perfil de Riesgo</h2> 
                <p>Responda las siguientes preguntas para determinar su perfil de riesgo:</p>

                <label for="perfil_cliente">¿Cuál es su perfil de riesgo?</label>
                <select id="perfil_cliente" name="perfil_cliente" required>
                    <option value="">Seleccione...</option>
                    <option value="conservador">Conservador</option>
                    <option value="moderado">Moderado</option>
                    <option value="dinamico">Dinámico</option>
                </select>
            
                
                <div class="buttons">
                    <button type="button" class="prev-btn">Anterior</button>
                    <button type="button" class="next-btn">Siguiente</button>
                </div>
            </div>
            

            <!-- ==================== PASO 2 Gastos recurrentes y discrecionales ==================== -->
            <div class="form-step" id="step-2">
                <h2>Gastos básicos recurrentes y discrecionales</h2>

                <label for="alquiler">Alquiler y/o mantenimiento (mensual y en US$):</label>
                <input type="number" id="alquiler" name="alquiler">

                <label for="alimentacion">Supermercado / Alimentación y compras en general (mensual y en US$):</label>
                <input type="number" id="alimentacion" name="alimentacion">

                <label for="servicios">Servicios básicos: Agua, luz, gas, teléfono, etc. (mensual y en US$):</label>
                <input type="number" id="servicios" name="servicios">

                <label for="sueldo">Sueldos de personal del hogar (mensual y en US$):</label>
                <input type="number" id="sueldo" name="sueldo">

                <label for="transporte">Transporte, gasolina, mantenimiento de vehículos (mensual y en US$):</label>
                <input type="number" id="transporte" name="transporte">

                <label for="otros">Otros gastos básicos no considerados en los puntos anteriores (mensual y en US$):</label>
                <input type="number" id="otros" name="otros">

                <label for="estilos">Gastos en estilo de vida (mensual y en US$):</label>
                <input type="number" id="estilos" name="estilos">

                <label for="viajes">Viajes (anual y en US$):</label>
                <input type="number" id="viajes" name="viajes">

                <label for="seguro">Seguro médico (mensual y en US$):</label>
                <input type="number" id="seguro" name="seguro">

                <label for="cambios">¿Cómo estima que se ajustarán sus gastos después de la jubilación?</label>
                <textarea id="cambios" name="cambios" rows="3"></textarea>

                <!--
                <label for="estado_civil_2">Estado civil:</label>
                <select id="estado_civil_2" name="estado_civil_2">
                    <option value="">Seleccione...</option>
                    <option>Soltero(a)</option>
                    <option>Casado(a)</option>
                    <option>Divorciado(a)</option>
                    <option>Viudo(a)</option>
                </select>

                <label>¿Tiene hijos?</label>
                <select id="tiene_hijos_2" name="tiene_hijos_2">
                    <option value="no">No</option>
                    <option value="si">Sí</option>
                </select>

                <div id="hijos_section_2" class="hidden">
                    <h3>Información de hijos</h3>
                    <label for="hijo1_fecha">Fecha de nacimiento hijo 1:</label>
                    <input type="date" id="hijo1_fecha" name="hijo1_fecha">
                </div>-->

                <div class="buttons">
                    <button type="button" class="prev-btn">Anterior</button>
                    <button type="button" class="next-btn">Siguiente</button>
                </div>
            </div>
            
            <!-- ==================== PASO 3 Bienes muebles e inmuebles ==================== -->
            <div class="form-step" id="step-3">
                <h2>Bienes Muebles e Inmuebles</h2>

                <label for="cambio_automovil">¿Cada cuántos años cambia de automóvil?</label>
                <input type="number" id="cambio_automovil" name="cambio_automovil">

                <label for="automovil">¿Qué monto destina a  cada cambio de automóvil? (US$):</label>
                <input type="number" id="automovil" name="automovil">

                <label for="anho_cambio_automovil">¿En qué año realizará el primer cambio de automóvil?</label>
                <input 
                    type="number" 
                    id="anho_cambio_automovil" 
                    name="anho_cambio_automovil" 
                    min="2020" 
                    max="2100" 
                    step="1" 
                    placeholder="Ej. 2028">

               <div id="propiedades_section" class="normal">
                    <div id="lista_propiedades"></div>
                    <button type="button" class="add-btn" id="agregar_propiedad">Agregar propiedad</button>
                </div>

                <label for="otros_inmuebles">Otros inmuebles de uso personal (US$):</label>
                <input type="number" id="otros_inmuebles" name="otros_inmuebles">

                <label for="inmuebles_inversion">Inmuebles de Inversión (US$)</label>
                <input type="number" id="inmuebles_inversion" name="inmuebles_inversion">

                <div class="buttons">
                    <button type="button" class="prev-btn">Anterior</button>
                    <button type="button" class="next-btn">Siguiente</button>
                </div>
            </div>
            
            <!-- ==================== PASO 4 Situación y Salud Patrimonial ==================== -->
            <div class="form-step" id="step-3">
                <h2>Patrimonio e Inversiones</h2>

                <label for="ahorros_corrientes">Cuentas de ahorros y corrientes (US$)</label>
                <input type="number" id="ahorros_corrientes" name="ahorros_corrientes">

                <label for="tiene_participacion">¿Cuenta con participación en Negocios?</label>
                <select id="tiene_participacion" name="tiene_participacion" required>
                    <option value="">Seleccione...</option>
                    <option value="si">Sí</option>
                    <option value="no">No</option>
                </select>

                <div id="participacion_section" class="hidden">
                    <div id="lista_participacion"></div>
                    <button type="button" class="add-btn" id="agregar_participacion">Agregar Particpación</button>
                </div>

                <label for="tiene_inversion">¿Cuenta con algún portafolio de inversión?</label>
                <select id="tiene_inversion" name="tiene_inversion" required>
                    <option value="">Seleccione...</option>
                    <option value="si">Sí</option>
                    <option value="no">No</option>
                </select>

                <div id="inversion_section" class="hidden">
                    <div id="lista_inversion"></div>
                    <button type="button" class="add-btn" id="agregar_inversion">Agregar Inversión</button>
                </div>
                
                <label for="situacion_laboral_titular">Situación Laboral del titular</label>
                <select id="situacion_laboral_titular" name="situacion_laboral_titular" required>
                    <option value="">Seleccione...</option>
                    <option value="Empleado">Empleado</option>
                    <option value="Independiente">Independiente</option>
                    <option value="Empresario">Empresario</option>
                    <option value="Jubilado">Jubilado</option>
                </select>

                <div id ="activo_section" class="hidden box-variables">
                    <label for="sueldo_titular">Sueldo del titular (anual y en US$.)</label>
                    <input type="number" id="sueldo_titular" name="sueldo_titular" required>

                    <label for="utilidades_titular">Utilidades y bono del titular (anual y en US$)</label>
                    <input type="number" id="utilidades_titular" name="utilidades_titular">

                    <div class="hidden">
                        <label for="ingreso_promedio">Ingreso promedio (anual y en US$)</label>
                        <input type="number" id="ingreso_promedio" name="ingreso_promedio">
                    </div>

                    <label for="edad_jubilacion">¿A qué edad se piensa jubilar?</label>
                    <input 
                        type="number" 
                        id="edad_jubilacion" 
                        name="edad_jubilacion" 
                        min="50" 
                        max="80" 
                        step="1" 
                        placeholder="Ej. 65">

                </div>

                <div id ="inactivo_section" class="hidden box-variables">

                    <label for="recibe_pension">¿Recibe una pensión mensual?</label>
                    <select id="recibe_pension" name="recibe_pension" required>
                        <option value="">Seleccione...</option>
                        <option value="si">Sí</option>
                        <option value="no">No</option>
                    </select>

                    <label for="ingreso_pension">Pensión promedio mensual (S/.)</label>
                    <input type="number" id="ingreso_pension" name="ingreso_pension">
                
                </div>

                <label for="es_aportante">¿Es aportante a algún Fondo de pension?</label>
                <select id="es_aportante" name="es_aportante" required>
                    <option value="">Seleccione...</option>
                    <option value="si">Sí</option>
                    <option value="no">No</option>
                </select>
                
                <div id = "Aportante_section" class="hidden box-variables">
                                       
                    <label for="tipo_fondo">Tipo de fondo de pensión</label>
                    <select id="tipo_fondo" name="tipo_fondo" required>
                        <option value="">Seleccione...</option>
                        <option value="AFP">AFP</option>
                        <option value="ONP">ONP</option>
                        <option value="Otros">Otros</option>
                    </select>
                    
                    <label for="valor_fondo">Valor de fondo de pensión actual (S/.)</label>
                    <input type="number" id="valor_fondo" name="valor_fondo">
                
                </div>

                



                <div id ="conyugue_situacion_section" class="hidden">
                    <h3>Patrimonio e Inversiones Cónyugue</h3>

                    <label for="situacion_laboral_conyugue">Situación Laboral del cónyugue</label>
                    <select id="situacion_laboral_conyugue" name="situacion_laboral_titular" required>
                        <option value="">Seleccione...</option>
                        <option value="Empleado_conyugue">Empleado</option>
                        <option value="Independiente_conyugue">Independiente</option>
                        <option value="Empresario_conyugue">Empresario</option>
                        <option value="Jubilado_conyugue">Jubilado</option>
                    </select>

                    <div id ="activo_section_conyugue" class="hidden box-variables">
                        <label for="sueldo_titular_conyugue">Sueldo del cónyugue (mensual y en S/.)</label>
                        <input type="number" id="sueldo_titular_conyugue" name="sueldo_titular_conyugue" required>

                        <label for="utilidades_titular_conyugue">Utilidades y bono del cónyugue (anual y en US$)</label>
                        <input type="number" id="utilidades_titular_conyugue" name="utilidades_titular_conyugue">

                        <label for="ingreso_promedio_conyugue">Ingreso promedio del cónyugue (mensual y en US$)</label>
                        <input type="number" id="ingreso_promedio_conyugue" name="ingreso_promedio_conyugue">

                        <label for="edad_jubilacion_conyugue">Edad exacta o estimada del cónyugue</label>
                        <input 
                            type="number" 
                            id="edad_jubilacion_conyugue" 
                            name="edad_jubilacion_conyugue" 
                            min="50" 
                            max="80" 
                            step="1" 
                            placeholder="Ej. 65">

                    </div>

                    <div id ="inactivo_section_conyugue" class="hidden box-variables">

                        <label for="recibe_pension_conyugue">¿El cónyugue recibe una pensión mensual?</label>
                        <select id="recibe_pension_conyugue" name="recibe_pension_conyugue" required>
                            <option value="">Seleccione...</option>
                            <option value="si">Sí</option>
                            <option value="no">No</option>
                        </select>

                        <label for="ingreso_pension_conyugue">Pensión promedio mensual del cónyugue (S/.)</label>
                        <input type="number" id="ingreso_pension_conyugue" name="ingreso_pension_conyugue">
                                        
                        <label for="valor_fondo_conyugue">Valor de fondo de pensión actual del cónyugue (S/.)</label>
                        <input type="number" id="valor_fondo_conyugue" name="valor_fondo_conyugue">

                    </div>
                
                </div>

                <label for="alquileres">Ingresos por Alquileres (mensual y en US$)</label>
                <input type="number" id="alquileres" name="alquileres">

                <label for="dividendos">Dividendos de negocios (anual y en US$)</label>
                <input type="number" id="dividendos" name="dividendos">

                <label for="otros_ingresos">Otros ingresos (anual y en US$)</label>
                <input type="number" id="otros_ingresos" name="otros_ingresos">

                <label for="ahorro_familiar">Valor de ahorro familiar (anual y en US$)</label>
                <input type="number" id="ahorro_familiar" name="ahorro_familiar">

                <div class="buttons">
                    <button type="button" class="prev-btn">Anterior</button>
                    <button type="button" class="next-btn">Siguiente</button>
                </div>
            </div>

            <!-- ==================== PASO 5 Gestión de Créditos/Deudas y Seguros de Vida ==================== -->
            <div class="form-step" id="step-4">
                <h2>Gestión de Créditos/Deudas y Seguros de vida</h2>

                <label for="tiene_creditos">¿Tienes Créditos/Deudas?</label>
                <select id="tiene_creditos" name="tiene_creditos" required>
                    <option value="">Seleccione...</option>
                    <option value="si">Sí</option>
                    <option value="no">No</option>
                </select>

                <div id="creditos_section" class="hidden">
                    <div id="lista_creditos"></div>
                    <button type="button" class="add-btn" id="agregar_creditos">Agregar Crédito</button>
                </div>
                
                <label for="seguro_vida">¿Cuenta con un seguro de vida?</label>
                <select id="seguro_vida" name="seguro_vida" required>
                    <option value="">Seleccione...</option>
                    <option value="si">Sí</option>
                    <option value="no">No</option>
                </select>

                <div id="detalles_seguro_vida" class="hidden">
                    <div class="child-card">
                        <label for="tipo_seguro">Tipo de seguro:</label>
                        <input type="text" id="tipo_seguro" name="tipo_seguro">

                        <label for="monto_seguro">Monto asegurado (US$):</label>
                        <input type="number" id="monto_seguro" name="monto_seguro">

                        <label for="monto_retorno">Monto de retorno (US$)</label>
                        <input type="number" id="monto_retorno" name="monto_retorno">

                        <label for="anhios_retiro">¿En cuántos años piensa retirar el monto señalado en la pregunta anterior?</label>
                        <input 
                            type="number" 
                            id="anhios_retiro" 
                            name="anhios_retiro" 
                            min="0" 
                            max="40" 
                            step="1" 
                            placeholder="Ej. 5">
                    </div>
                </div>
                

                <div class="buttons">
                    <button type="button" class="prev-btn">Anterior</button>
                    <button type="button" class="next-btn">Siguiente</button>
                </div>

            </div>


            <!-- ==================== PASO 6 Objetivos Financieros ==================== -->
            <div class="form-step" id="step-5">
                <h2>Objetivos Financieros</h2>

                <label for="tiene_objetivos">¿Tienes Objetivos o Metas Financieras?</label>
                <select id="tiene_objetivos" name="tiene_objetivos" required>
                    <option value="">Seleccione...</option>
                    <option value="si">Sí</option>
                    <option value="no">No</option>
                </select>

                <div id="objetivos_section" class="hidden">
                    <div id="lista_objetivos"></div>
                    <button type="button" class="add-btn" id="agregar_objetivos">Agregar Objetivos Financieros</button>
                </div>

                <div class="buttons">
                    <button type="button" class="prev-btn">Anterior</button>
                    <button id="btnFinalizar" type="button" class="btn btn-success">
                        Finalizar y generar resultados
                    </button>
                </div>
            </div>


            <!-- ==================== PASO FINAL ==================== -->
            <div class="form-step" id="step-final">
                <h2>Resultados del Plan de Financiamiento</h2>
                <p>Aquí se mostrarán tus resultados, gráficos, y recomendaciones.</p>

                <!-- Placeholder donde Flask inyectará resultados o gráficos -->
                <div id="resultado-container"></div>

                <!-- Botón para generar el PDF (por ahora no funcional) -->
                <button id="btnPDF" type="button" class="submit-btn">Descargar PDF</button>
            </div>
        </form>
    </main>

    <script>
        const steps = document.querySelectorAll(".form-step");
        const nextBtns = document.querySelectorAll(".next-btn");
        const prevBtns = document.querySelectorAll(".prev-btn");
        const progress = document.getElementById("progress");

        const estadoCivil = document.getElementById('estado_civil');
        const conyugeSection = document.getElementById('conyuge_section');
        const conyugepatrimonioSection = document.getElementById('conyugue_situacion_section');

        const seguroVidaSelect = document.getElementById('seguro_vida');
        const seguroVidaSection = document.getElementById('detalles_seguro_vida');

        const hijosSelect = document.getElementById('tiene_hijos');
        const hijosSection = document.getElementById('hijos_section');
        const agregarHijo = document.getElementById('agregar_hijo');
        const listaHijos = document.getElementById('lista_hijos');

        const agregarPropiedad = document.getElementById('agregar_propiedad');
        const listaPropiedades = document.getElementById('lista_propiedades');

        const participacionSelect = document.getElementById('tiene_participacion');
        const participacionSection = document.getElementById('participacion_section');
        const agregarParticipacion = document.getElementById('agregar_participacion');
        const listaparticipacion = document.getElementById('lista_participacion');

        const inversionSelect = document.getElementById('tiene_inversion');
        const inversionSection = document.getElementById('inversion_section');
        const agregarInversion = document.getElementById('agregar_inversion');
        const listainversion = document.getElementById('lista_inversion');

        const objetivosSelect = document.getElementById('tiene_objetivos');
        const objetivosSection = document.getElementById('objetivos_section');
        const agregarObjetivos = document.getElementById('agregar_objetivos');
        const listaObjetivos = document.getElementById('lista_objetivos');

        const creditoSelect = document.getElementById('tiene_creditos');
        const creditoSection = document.getElementById('creditos_section');
        const agregarCredito = document.getElementById('agregar_creditos');
        const listaCredito = document.getElementById('lista_creditos');

        const activoSection = document.getElementById('activo_section');
        const inactivoSection = document.getElementById('inactivo_section');

        const esAportanteSelect = document.getElementById('es_aportante');
        const aportanteSection = document.getElementById('Aportante_section');

        const pensionistaSelect = document.getElementById('recibe_pension');
        const situacionSelect = document.getElementById('situacion_laboral_titular');

        const activoSectionConyugue = document.getElementById('activo_section_conyugue');
        const inactivoSectionConyugue = document.getElementById('inactivo_section_conyugue');

        const pensionistaSelectConyugue = document.getElementById('recibe_pension_conyugue');
        const situacionSelectConyugue = document.getElementById('situacion_laboral_conyugue');


        let currentStep = 0;
        let contadorHijos = 0;
        let contadorPropiedad = 0;
        let contadorParticipacion = 0;
        let contadorInversion = 0;
        let contadorCreditos = 0;
        let contadorObjetivos = 0;

        seguroVidaSelect.addEventListener('change', () => {
            if (seguroVidaSelect.value === 'si') {
                seguroVidaSection.classList.remove('hidden');
            } else {
                seguroVidaSection.classList.add('hidden');
                document.getElementById('tipo_seguro').value = '';
                document.getElementById('monto_seguro').value = '';
                document.getElementById('monto_retorno').value = '';
                document.getElementById('anhios_retiro').value = '';
            }
        });

        //Mostrar / ocultar sección de aportante
        esAportanteSelect.addEventListener('change', () => {
            if (esAportanteSelect.value === 'si') {
                aportanteSection.classList.remove('hidden');
            } else {
                aportanteSection.classList.add('hidden');
                document.getElementById('tipo_fondo').value = '';
                document.getElementById('valor_fondo').value = '';
            }
        });

        // Mostrar cónyuge
        estadoCivil.addEventListener('change', () => {
            const esCasado = estadoCivil.value === 'Casado';
            conyugeSection.classList.toggle('hidden', !esCasado);
            conyugepatrimonioSection.classList.toggle('hidden', !esCasado);

            // Si no es casado, limpiar los campos del cónyuge
            if (!esCasado) {
                document.getElementById('nombre_conyuge').value = '';
                document.getElementById('fecha_conyuge').value = '';

                // Patrimonio
                document.getElementById('situacion_laboral_conyugue').value = '';
                document.getElementById('sueldo_titular_conyugue').value = '';
                document.getElementById('utilidades_titular_conyugue').value = '';
                document.getElementById('ingreso_promedio_conyugue').value = '';
                document.getElementById('edad_jubilacion_conyugue').value = '';
                document.getElementById('recibe_pension_conyugue').value = '';
                document.getElementById('ingreso_pension_conyugue').value = '';
                document.getElementById('valor_fondo_conyugue').value = '';
            }
        });

        // Mostrar / ocultar hijos
        hijosSelect.addEventListener('change', () => {
            if (hijosSelect.value === 'si') {
                hijosSection.classList.remove('hidden');
            } else {
                hijosSection.classList.add('hidden');
                listaHijos.innerHTML = '';
                contadorHijos = 0;
            }
        });

        // Mostrar / ocultar participacion
        participacionSelect.addEventListener('change', () => {
            if (participacionSelect.value === 'si') {
                participacionSection.classList.remove('hidden');
            } else {
                participacionSection.classList.add('hidden');
                listaparticipacion.innerHTML = '';
                contadorParticipacion = 0;
            }
        });

        // Mostrar / ocultar inversion
        inversionSelect.addEventListener('change', () => {
            if (inversionSelect.value === 'si') {
                inversionSection.classList.remove('hidden');
            } else {
                inversionSection.classList.add('hidden');
                listainversion.innerHTML = '';
                contadorInversion = 0;
            }
        });

        // Mostrar / ocultar creditos
        creditoSelect.addEventListener('change', () => {
            if (creditoSelect.value === 'si') {
                creditoSection.classList.remove('hidden');
            } else {
                creditoSection.classList.add('hidden');
                listaCredito.innerHTML = '';
                contadorCreditos = 0;
            }
        });

        objetivosSelect.addEventListener('change', () => {
            if (objetivosSelect.value === 'si') {
                objetivosSection.classList.remove('hidden');
            } else {
                objetivosSection.classList.add('hidden');
                listaObjetivos.innerHTML = '';
                contadorObjetivos = 0;
            }
        });

        pensionistaSelect.addEventListener('change', () => {
            const esPensionista = pensionistaSelect.value === 'si';
            document.getElementById('ingreso_pension').disabled = !esPensionista;

            // Si no es pensionista, limpiar el campo relacionado
            if (!esPensionista) {
                document.getElementById('ingreso_pension').value = '';
            }
        });

        pensionistaSelectConyugue.addEventListener('change', () => {
            const esPensionistaConyugue = pensionistaSelectConyugue.value === 'si';
            document.getElementById('ingreso_pension_conyugue').disabled = !esPensionistaConyugue;

            // Si no es pensionista, limpiar el campo relacionado
            if (!esPensionistaConyugue) {
                document.getElementById('ingreso_pension_conyugue').value = '';
            }
        });

        
        // Mostrar / ocultar sección de activo
        situacionSelect.addEventListener('change', () => {
            const esActivo = situacionSelect.value === 'Empleado' || situacionSelect.value === 'Independiente' || situacionSelect.value === 'Empresario';
            activoSection.classList.toggle('hidden', !esActivo);

            // Si no es activo, limpiar los campos relacionados
            if (!esActivo) {
                //activoSection.classList.add('hidden');
                document.getElementById('sueldo_titular').value = '';
                document.getElementById('utilidades_titular').value = '';
                document.getElementById('ingreso_promedio').value = '';
                document.getElementById('edad_jubilacion').value = '';
                inactivoSection.classList.remove('hidden');
            
            } else{
                inactivoSection.classList.add('hidden');
                document.getElementById('recibe_pension').value = '';
                document.getElementById('ingreso_pension').value = '';
                activoSection.classList.remove('hidden');
                
            }
        });


        // Mostrar / ocultar sección de activo cónyugue
        situacionSelectConyugue.addEventListener('change', () => {
            const esActivoConyugue = situacionSelectConyugue.value === 'Empleado_conyugue' || situacionSelectConyugue.value === 'Independiente_conyugue' || situacionSelectConyugue.value === 'Empresario_conyugue';
            activoSectionConyugue.classList.toggle('hidden', !esActivoConyugue);

            // Si no es activo, limpiar los campos relacionados
            if (!esActivoConyugue) {
                //activoSection.classList.add('hidden');
                document.getElementById('sueldo_titular_conyugue').value = '';
                document.getElementById('utilidades_titular_conyugue').value = '';
                document.getElementById('ingreso_promedio_conyugue').value = '';
                document.getElementById('edad_jubilacion_conyugue').value = '';
                inactivoSectionConyugue.classList.remove('hidden');
            
            } else{
                inactivoSectionConyugue.classList.add('hidden');
                document.getElementById('recibe_pension_conyugue').value = '';
                document.getElementById('ingreso_pension_conyugue').value = '';
                activoSectionConyugue.classList.remove('hidden');
                
            }
        });

        
        agregarObjetivos.addEventListener('click', () => {
            contadorObjetivos++;
            const objetivoDiv = document.createElement('div');
            objetivoDiv.classList.add('child-card');
            objetivoDiv.innerHTML = `
                <div class="child-header">
                    <h4>Objetivo ${contadorObjetivos}</h4>
                    <button type="button" class="delete-objetivo">✖</button>
                </div>

                <label>Objetivo Financiero a cumplir:</label>
                <input type="text" name="objetivo_descripcion_${contadorObjetivos}" required>

                <label>Monto necesario (US$):</label>
                <input type="number" name="objetivo_monto_${contadorObjetivos}" min="0" required>

                <label>¿En cuántos años desea cumplir este objetivo?</label>
                <input 
                            type="number" 
                            id="objetivo_anos_${contadorObjetivos}" 
                            name="objetivo_anos_${contadorObjetivos}" 
                            min="0" 
                            max="40" 
                            step="1" 
                            placeholder="Ej. 5"
                            required>
            `;
            listaObjetivos.appendChild(objetivoDiv);

            objetivoDiv.querySelector(".delete-objetivo").addEventListener("click", () => {
                objetivoDiv.remove();
                contadorObjetivos--;
            });
        });

        //Agregar inversion dinámicamente
        agregarInversion.addEventListener('click', () => {
            contadorInversion++;

            const inversionDiv = document.createElement('div');
            inversionDiv.classList.add('child-card');

            inversionDiv.innerHTML = `
                <div class="child-header">
                    <h4>Inversión ${contadorInversion}</h4>
                    <button type="button" class="delete-inversion">✖</button>
                </div>

                <label>Procedencia de la inversión:</label>
                <select name="inversion_extranjera_${contadorInversion}" required>
                    <option value="">Seleccione...</option>
                    <option value="false">Local</option>
                    <option value="true">Extranjera</option>
                </select>

                <label>Portafolio de Inversión (US$):</label>
                <input type="number" name="inversion_valor_${contadorInversion}" min="0" required>

                <label>Perfil de Inversión:</label>
                <select id="inversion_tipo_${contadorInversion}" name="inversion_tipo_${contadorInversion}" required>
                    <option value="">Seleccione...</option>
                    <option value="Conservador">Conservador</option>
                    <option value="Moderado">Moderado</option>
                    <option value="Dinamico">Dinámico</option>
                </select>

                <div class="multi-slider">
                    <div class="bar">
                        <div class="seg fija"></div>
                        <div class="seg variable"></div>
                        <div class="seg altern"></div>
                        <div class="seg cash"></div>
                    </div>

                    <input type="range" min="0" max="100" value="25" class="handle h1">
                    <input type="range" min="0" max="100" value="50" class="handle h2">
                    <input type="range" min="0" max="100" value="75" class="handle h3">
                </div>

                <div class="valores"></div>
            `;

            listainversion.appendChild(inversionDiv);

            // Seleccionar sliders y segmentos DENTRO de la tarjeta
            const h1 = inversionDiv.querySelector(".h1");
            const h2 = inversionDiv.querySelector(".h2");
            const h3 = inversionDiv.querySelector(".h3");

            const sF = inversionDiv.querySelector(".fija");
            const sV = inversionDiv.querySelector(".variable");
            const sA = inversionDiv.querySelector(".altern");
            const sC = inversionDiv.querySelector(".cash");

            const out = inversionDiv.querySelector(".valores");

            function update() {
                if (+h1.value > +h2.value) h1.value = h2.value;
                if (+h2.value > +h3.value) h2.value = h3.value;

                const p1 = +h1.value;
                const p2 = +h2.value;
                const p3 = +h3.value;

                const fija  = p1;
                const variable = p2 - p1;
                const altern = p3 - p2;
                const cash = 100 - p3;

                sF.style.width = fija + "%";
                sV.style.width = variable + "%";
                sA.style.width = altern + "%";
                sC.style.width = cash + "%";

                out.innerHTML = `
                    Fija: ${fija}%<br>
                    Variable: ${variable}%<br>
                    Alternativos: ${altern}%<br>
                    Cash: ${cash}%`;
            }

            // Listeners para esta inversión
            [h1, h2, h3].forEach(h => h.addEventListener("input", update));

            update();

            inversionDiv.querySelector(".delete-inversion").addEventListener("click", () => {
                inversionDiv.remove();
                contadorInversion--;
            });
        });


        //Agregar propiedad dinámicamente
        agregarPropiedad.addEventListener('click', () => {
            contadorPropiedad++;
            const propiedadDiv = document.createElement('div');
            propiedadDiv.classList.add('child-card');
            propiedadDiv.innerHTML = `
                <div class="child-header">
                    <h4>Propiedad ${contadorPropiedad}</h4>
                    <button type="button" class="delete-propiedad">✖</button>
                </div>

                <label>Tipo de propiedad:</label>
                <select name="propiedad_tipo_${contadorPropiedad}" required>
                    <option value="">Seleccione...</option>
                    <option>Casa</option>
                    <option>Departamento</option>
                    <option>Terreno</option>
                    <option>Local comercial</option>
                    <option>Oficina/Edificio oficinas</option>
                    <option>Otro</option>
                </select>
                
                <label>Ubicación de la propiedad:</label>
                <select name="propiedad_ubicacion_${contadorPropiedad}" required>
                    <option value="">Seleccione...</option>
                    <option value="false">Local</option>
                    <option value="true">Extranjera</option>
                </select>

                <label>Valor de la propiedad (US$):</label>
                <input type="number" name="propiedad_valor_${contadorPropiedad}" min="0" required>
            `;
            listaPropiedades.appendChild(propiedadDiv);
            [h1,h2,h3].forEach(h => h.addEventListener("input", update));

            update();
            propiedadDiv.querySelector(".delete-propiedad").addEventListener("click", () => {
                propiedadDiv.remove();
                contadorPropiedad--;
            });
        });

        //Agregar participacion dinámicamente
        agregarParticipacion.addEventListener('click', () => {
            contadorParticipacion++;
            const participacionDiv = document.createElement('div');
            participacionDiv.classList.add('child-card');
            participacionDiv.innerHTML = `
                <div class="child-header">
                    <h4>Participación ${contadorParticipacion}</h4>
                    <button type="button" class="delete-participacion">✖</button>
                </div>


                <!--
                <label>Nombre del negocio:</label>
                <input type="text" name="negocio_nombre_${contadorParticipacion}" required>
              
                <label>Porcentaje de participación (%):</label>
                <input type="number" name="negocio_porcentaje_${contadorParticipacion}" min="0" max="100" required>
                -->

                <label>Valor estimado de la participación (US$):</label>
                <input type="number" name="negocio_valor_${contadorParticipacion}" min="0" required>
            `;
            listaparticipacion.appendChild(participacionDiv);

            participacionDiv.querySelector(".delete-participacion").addEventListener("click", () => {
                participacionDiv.remove();
                contadorParticipacion--;
            });
        });

        // Agregar hijos dinámicamente
        agregarHijo.addEventListener('click', () => {
            contadorHijos++;
            const hijoDiv = document.createElement('div');
            hijoDiv.classList.add('child-card');
            hijoDiv.innerHTML = `
                <div class="child-header">
                    <h4>Hijo ${contadorHijos}</h4>
                    <button type="button" class="delete-hijo">✖</button>
                </div>

                <label>Fecha de nacimiento:</label>
                <input type="date" name="hijo_fecha_${contadorHijos}" required>

                <label>Tipo de educación:</label>
                <select name="hijo_educacion_${contadorHijos}" required>
                    <option value="">Seleccione...</option>
                    <option>Kinder</option>
                    <option>Colegio</option>
                    <option>Universidad</option>
                    <option>Postgrado</option>
                    <option>Instituto</option>
                    <option>Otros</option>
                </select>

                <label>Costo anual de educación (S/):</label>
                <input type="number" name="hijo_costo_${contadorHijos}" min="0" required>

                <div class="universidad-extra" style="display: none; margin-top: 10px;">
                    <label>¿Desea anualizar el pago futuro de la universidad?</label>
                    <select class="anualizar-select" name="hijo_anualizar_${contadorHijos}">
                        <option value="">Seleccione...</option>
                        <option value="si">Sí</option>
                        <option value="no">No</option>
                    </select>

                    <div class="costo-universidad" style="display: none; margin-top: 10px;">
                        <label>Costo anualizado de la universidad (S/):</label>
                        <input type="number" name="hijo_anualizado_${contadorHijos}" min="0">
                    </div>
                </div>
            `;
            listaHijos.appendChild(hijoDiv);

            hijoDiv.querySelector(".delete-hijo").addEventListener("click", () => {
                hijoDiv.remove();
            });

            //Logica para mostrar campos adicionales según educación
            const educacionSelect = hijoDiv.querySelector(`select[name="hijo_educacion_${contadorHijos}"]`);
            const universidadExtra = hijoDiv.querySelector(".universidad-extra");
            const anualizarSelect = hijoDiv.querySelector(`select[name="hijo_anualizar_${contadorHijos}"]`);
            const costoUniversidad = hijoDiv.querySelector(".costo-universidad");

            educacionSelect.addEventListener("change", () => {
                if (educacionSelect.value === "Kinder" || educacionSelect.value === "Colegio") {
                    universidadExtra.style.display = "block";
                } else {
                    universidadExtra.style.display = "none";
                    costoUniversidad.style.display = "none"; // ocultar si cambia de opción
                    anualizarSelect.value = "";
                }
            });

            anualizarSelect.addEventListener("change", () => {
                if (anualizarSelect.value === "si") {
                    costoUniversidad.style.display = "block";
                } else {
                    costoUniversidad.style.display = "none";
                }
            });
           
        });


        


        // Agregar créditos dinámicamente
        agregarCredito.addEventListener('click', () => {
            const creditoDiv = document.createElement('div');
            contadorCreditos++;
            creditoDiv.classList.add('child-card');
            creditoDiv.innerHTML = `
                <div class="child-header">
                    <h4>Crédito ${contadorCreditos}</h4>
                    <button type="button" class="delete-credito">✖</button>
                </div>

                <label>Tipo de crédito:</label>
                <select name="credito_tipo[]" required>
                    <option value="">Seleccione...</option>
                    <option>Hipotecario</option>
                    <option>Vehicular</option>
                    <option>Personal</option>
                    <option>Tarjeta de crédito</option>
                    <option>Otros</option>
                </select>

                <label>Entidad financiera:</label>
                <input type="text" name="credito_entidad[]" required>

                <label>Monto original (US$):</label>
                <input type="number" name="credito_monto_original[]" min="0" required>

                <label>Saldo actual del crédito (US$):</label>
                <input type="number" name="credito_saldo_actual[]" min="0" required>

                <label>Tasa de interés anual (%):</label>
                <input type="number" name="credito_tasa_interes[]" min="0" step="0.01" required>

                <label>Plazo restante (meses):</label>
                <input type="number" name="credito_plazo_restante[]" min="0" required>

                <label>Pago mensual (US$):</label>
                <input type="number" name="credito_pago_mensual[]" min="0" required>
            `;
            listaCredito.appendChild(creditoDiv);
            
            creditoDiv.querySelector(".delete-credito").addEventListener("click", () => {
                creditoDiv.remove();
            });
        });


        // Control de pasos
        nextBtns.forEach(btn => btn.addEventListener("click", () => changeStep(1)));
        prevBtns.forEach(btn => btn.addEventListener("click", () => changeStep(-1)));

        function changeStep(direction) {
            steps[currentStep].classList.remove("active");
            currentStep += direction;
            steps[currentStep].classList.add("active");
            progress.style.width = ((currentStep + 1) / steps.length) * 100 + "%";
            window.scrollTo({ top: 0, behavior: "smooth" });
        }
        
        // Consulta a Salesforce
        async function consultarSalesforce(tipo_id, numero_id) {

            try {
                const resp = await fetch("/salesforce/cliente", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ tipo_id, numero_id })
                });

                if (!resp.ok) return null;  // Error del servidor → ignorar

                const data = await resp.json();

                if (!data || !data.encontrado) return null; // No existe → tratar como vacío
                
                return data; // Cliente encontrado
            } catch (error) {
                return null; // Error → ignorar y avanzar normal
            }
        }

        document.getElementById("btn-siguiente-1").addEventListener("click", async () => {

    
            const tipo_id = document.getElementById("tipo_id").value;
            const numero_id = document.getElementById("numero_id").value;

            const clienteSF = await consultarSalesforce(tipo_id, numero_id);

            if (clienteSF) {
                // 🎯 Cliente EXISTE → saltar step perfilamiento
                console.log("Perfil encontrado:", clienteSF);
                changeStep(2); // 🔥 saltamos 1 step adicional
            } else {
                // ❌ No encontrado o error → avanzar normal
                changeStep(1);
            }
        });



        document.getElementById("btnFinalizar").addEventListener("click", async () => {
            // Aquí puedes reutilizar TODO el bloque del script anterior (el que arma el JSON completo)
            // ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓

            const titular = {
                tipo_id: document.getElementById("tipo_id").value,
                numero_id: document.getElementById("numero_id").value,
                nombres: document.getElementById("nombres").value,
                apellidos: document.getElementById("apellidos").value,
                correo: document.getElementById("correo").value,
                fecha_nacimiento: document.getElementById("fecha_nacimiento").value,
                estado_civil: document.getElementById("estado_civil").value,
                edad_jubilacion: document.getElementById("edad_jubilacion").value,
                codigo: document.getElementById("codigo").value,
                hub: document.getElementById("hub").value,
                objetivos_personales: document.getElementById("objetivos").value
            };

            // ===== Cónyuge (si aplica) =====
            let conyuge = null;
            if (titular.estado_civil === "Casado") {
                conyuge = {
                    nombre: document.getElementById("nombre_conyuge").value,
                    fecha_nacimiento: document.getElementById("fecha_conyuge").value,
                    situacion_laboral: document.getElementById("situacion_laboral_conyugue").value,
                    sueldo: document.getElementById("sueldo_titular_conyugue").value,
                    utilidades: document.getElementById("utilidades_titular_conyugue").value,
                    ingreso_promedio: document.getElementById("ingreso_promedio_conyugue").value,
                    edad_jubilacion: document.getElementById("edad_jubilacion_conyugue").value,
                    recibe_pension: document.getElementById("recibe_pension_conyugue").value,
                    ingreso_pension: document.getElementById("ingreso_pension_conyugue").value,
                    valor_fondo: document.getElementById("valor_fondo_conyugue").value
                };
            }

            // ===== Hijos =====
            const hijos = Array.from(document.querySelectorAll("#lista_hijos .child-card")).map(div => ({
                fecha_nacimiento: div.querySelector("[name^='hijo_fecha_']").value,
                educacion: div.querySelector("[name^='hijo_educacion_']").value,
                costo_anual: div.querySelector("[name^='hijo_costo_']").value,
                anualizado_universidad: div.querySelector("[name^='hijo_anualizar_']").value,
                costo_universidad: div.querySelector("[name^='hijo_anualizado_']").value
            }));
            
            // ===== Propiedades =====
            const propiedades = Array.from(document.querySelectorAll("#lista_propiedades .child-card")).map(div => ({
                extranjera: div.querySelector("[name^='propiedad_ubicacion_']").value,
                valor: div.querySelector("[name^='propiedad_valor_']").value,
                tipo: div.querySelector("[name^='propiedad_tipo_']").value
                
            }));

            // ===== Otras Propiedades =====
            const otras_propiedades = {
                otros_inmuebles: document.getElementById("otros_inmuebles").value,
                inmuebles_inversion: document.getElementById("inmuebles_inversion").value
            };

            // ===== Participaciones =====
            const participaciones = Array.from(document.querySelectorAll("#lista_participacion .child-card")).map(div => ({
                valor: div.querySelector("[name^='negocio_valor_']").value
            }));

            // ===== Inversiones =====
            const inversiones = Array.from(document.querySelectorAll("#lista_inversion .child-card")).map(div => ({
                extranjera: div.querySelector("[name^='inversion_extranjera_']").value,
                valor: div.querySelector("[name^='inversion_valor_']").value,
                tipo: div.querySelector("[name^='inversion_tipo_']").value
            }));

            // ===== Créditos =====
            const creditos = Array.from(document.querySelectorAll("#lista_creditos .child-card")).map(div => ({
                tipo: div.querySelector("[name='credito_tipo[]']").value,
                entidad: div.querySelector("[name='credito_entidad[]']").value,
                monto_original: div.querySelector("[name='credito_monto_original[]']").value,
                saldo_actual: div.querySelector("[name='credito_saldo_actual[]']").value,
                tasa_interes: div.querySelector("[name='credito_tasa_interes[]']").value,
                plazo_restante: div.querySelector("[name='credito_plazo_restante[]']").value,
                pago_mensual: div.querySelector("[name='credito_pago_mensual[]']").value
            }));

            // ===== Objetivos =====
            const objetivos = Array.from(document.querySelectorAll("#lista_objetivos .child-card")).map(div => ({
                descripcion: div.querySelector("[name^='objetivo_descripcion_']").value,
                monto: div.querySelector("[name^='objetivo_monto_']").value,
                anos: div.querySelector("[name^='objetivo_anos_']").value
            }));

            // ===== Gastos =====
            const gastos = {
                alquiler: document.getElementById("alquiler").value,
                alimentacion: document.getElementById("alimentacion").value,
                servicios: document.getElementById("servicios").value,
                sueldo_personal: document.getElementById("sueldo").value,
                transporte: document.getElementById("transporte").value,
                otros: document.getElementById("otros").value,
                estilos: document.getElementById("estilos").value,
                viajes: document.getElementById("viajes").value,
                seguro: document.getElementById("seguro").value,
                cambios: document.getElementById("cambios").value
            };

            // ===== Patrimonio / Ingresos =====
            const patrimonio = {
                ahorro_corriente: document.getElementById("ahorros_corrientes").value,
                sueldo_titular: document.getElementById("sueldo_titular").value,
                ingreso_promedio: document.getElementById("ingreso_promedio").value,
                alquileres: document.getElementById("alquileres").value,
                dividendos: document.getElementById("otros_ingresos").value,
                ahorro_familiar: document.getElementById("ahorro_familiar").value,
                utilidades_bonos: document.getElementById("utilidades_titular").value
            };

            // ===== Seguro de vida =====
            const seguro_vida = (document.getElementById("seguro_vida").value === "si")
                ? {
                    tipo: document.getElementById("tipo_seguro").value,
                    monto: document.getElementById("monto_seguro").value,
                    retorno: document.getElementById("monto_retorno").value,
                    anhos_retiro: document.getElementById("anhios_retiro").value
                }
                : null;


            const perfil_riesgo = document.getElementById("perfil_cliente").value;

            const pensiones = {
                es_aportante: document.getElementById("es_aportante").value,
                tipo_fondo: document.getElementById("tipo_fondo").value,
                valor_fondo: document.getElementById("valor_fondo").value,
                porcentaje_pension: 0.06,
                inflacion_porcentual: 0.03
            };
            
            // ... (resto del JSON igual al bloque anterior)
            // termina con:
            const datos = {
                titular,
                conyuge,
                hijos,
                participaciones,
                propiedades,
                otras_propiedades,
                inversiones,
                creditos,
                objetivos,
                gastos,
                patrimonio,
                seguro_vida,
                perfil_riesgo,
                pensiones
            };

            console.log("JSON generado:", datos);

            // Mostrar loading
            document.getElementById("btnFinalizar").disabled = true;
            document.getElementById("btnFinalizar").textContent = "Procesando...";

            // Enviar a Flask
            const res = await fetch("/guardar_datos", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(datos)
            });

            if (res.ok) {
                const respuesta = await res.json();
                console.log("Guardado:", respuesta);

                localStorage.setItem("resultados_financieros", JSON.stringify(respuesta));
                localStorage.setItem("datos_originales", JSON.stringify(datos));

                // Redirigir a página de resultados
                window.location.href = "/resultados";

                // Mostrar resultados en la pantalla final
                /*const contenedor = document.getElementById("resultado-container");
                contenedor.innerHTML = `
                <h3>Resumen Financiero</h3>
                <p><strong>Ingresos:</strong> ${respuesta.ingresos_totales}</p>
                <p><strong>Gastos:</strong> ${respuesta.gastos_totales}</p>
                <p><strong>Ahorro Neto:</strong> ${respuesta.ahorro_neto}</p>
                <div>${respuesta.graficos_html || ""}</div>
                `;

                // Avanza al paso final
                document.querySelector("#step-5").classList.remove("active");
                document.querySelector("#step-final").classList.add("active");*/
            } else {
                alert("Error al guardar los datos");
            }

            document.getElementById("btnFinalizar").disabled = false;
            document.getElementById("btnFinalizar").textContent = "Finalizar y generar resultados";
        });
    </script>
</body>
</html>
